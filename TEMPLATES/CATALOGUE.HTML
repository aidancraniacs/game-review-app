{% extends "BASE.HTML" %}
{% block content %}

<!--catalogue page
    acts as the main discovery+review interaction hub-->
<section class="catalogue-page">

<!--popular games
    horizontally scrollable row
    optimised for quick browsing+visual appeal-->
  <section class="catalogue-section">
    <h2>ðŸ”¥ Popular Games</h2>

    <div class="game-row">
      {% for game in popular_games %}
        <!--entire card is clickable for better ux
            pjax enabled to avoid full reload-->
        <a
          href="{{ url_for('game_detail', game_id=game.id) }}"
          class="game-link"
          data-pjax
        >
          <article class="game-card horizontal">

            <!--game cover image-->
            <div class="cover">
              <img
                src="{{ url_for('static', filename=game.cover_url) if game.cover_url else url_for('static', filename='cover-placeholder.png') }}"
                alt="{{ game.title }} cover"
                loading="lazy"
              >
            </div>

            <!--basic metadata-->
            <div class="game-info">
              <h3>{{ game.title }}</h3>

              <!--avg rating+review count-->
              <p class="rating">
                {{ game.avg_rating or 'â€”' }}/5
                <span class="muted">({{ game.review_count }})</span>
              </p>
            </div>

          </article>
        </a>
      {% endfor %}
    </div>
  </section>

<!--notable games
    same layout as popular for visual consistency-->
  <section class="catalogue-section">
    <h2>âœ¨ Notable Games</h2>

    <div class="game-row">
      {% for game in new_games %}
        <a
          href="{{ url_for('game_detail', game_id=game.id) }}"
          class="game-link"
          data-pjax
        >
          <article class="game-card horizontal">

            <div class="cover">
              <img
                src="{{ url_for('static', filename=game.cover_url) if game.cover_url else url_for('static', filename='cover-placeholder.png') }}"
                alt="{{ game.title }} cover"
                loading="lazy"
              >
            </div>

            <div class="game-info">
              <h3>{{ game.title }}</h3>

              <!--rating shown without count to keep it lightweight-->
              <p class="rating">
                {{ game.avg_rating or 'â€”' }}/5
              </p>
            </div>

          </article>
        </a>
      {% endfor %}
    </div>
  </section>

<!--full game catalogue
    grid layout with inline review submission-->
  <section class="catalogue-section">
    <h2>ðŸŽ® All Games</h2>

    <div class="game-grid">
      {% for game in games %}

        <!--fetch the current users review for this game(if any)
            used to prefill form fields-->
        {% set my_review = game.reviews
          | selectattr("user_id", "equalto", user.id)
          | first
        %}

        <article class="game-card vertical">

          <!--large cover for grid cards-->
          <div class="cover large">
            <img
              src="{{ url_for('static', filename=game.cover_url) if game.cover_url else url_for('static', filename='cover-placeholder.png') }}"
              alt="{{ game.title }} cover"
              loading="lazy"
            >
          </div>

          <!--game title-->
          <h3>{{ game.title }}</h3>

          <!--aggregate rating info-->
          <p class="rating">
            {% if game.review_count %}
              â˜… {{ game.avg_rating }}
              <span class="muted">Â· {{ game.review_count }} reviews</span>
            {% else %}
              <span class="muted">No ratings yet</span>
            {% endif %}
          </p>

          <!--secondary navigation to full detail page-->
          <a
            href="{{ url_for('game_detail', game_id=game.id) }}"
            class="muted small-link"
            data-pjax
          >
            View details â†’
          </a>

          <!--review form
              handles both create+update-->
          <form method="post" action="{{ url_for('games') }}" data-pjax>
            <input type="hidden" name="game_id" value="{{ game.id }}">

            <!--review title-->
            <label>
              Review title
              <input
                type="text"
                name="title"
                maxlength="100"
                placeholder="Summarise your thoughts"
                value="{{ my_review.title if my_review else '' }}"
              />
            </label>

            <!--current rating display-->
            <h4 class="rating-header">
              Your rating:
              <span class="rating-value">
                {{ my_review.rating if my_review else 'â€”' }}
              </span>
            </h4>

            <!--interactive star rating widget
                controlled entirely via js-->
            <div class="star-rating" aria-label="Star rating">

              <!--actual value submitted-->
              <input
                type="hidden"
                name="rating"
                value="{{ my_review.rating if my_review else '' }}"
                required
              />

              <!--visual star buttons-->
              <button type="button">â˜…</button>
              <button type="button">â˜…</button>
              <button type="button">â˜…</button>
              <button type="button">â˜…</button>
              <button type="button">â˜…</button>

              <span class="rating-text">Select a rating</span>
            </div>

            <!--review content-->
            <label>
              Review
              <textarea
                name="content"
                rows="2"
              >{{ my_review.content if my_review else '' }}</textarea>
            </label>

            <!--submit/update-->
            <button class="btn small" type="submit">
              {{ 'Update review' if my_review else 'Submit review' }}
            </button>
          </form>

<!--delete review(only shown if review exists)
    uses global confirmation modal-->
          {% if my_review %}
            <form
              method="post"
              action="{{ url_for('delete_review', review_id=my_review.id) }}"
              data-confirm
              style="margin-top:8px"
            >
              <button class="btn ghost small" type="submit">
                Delete review
              </button>
            </form>
          {% endif %}

        </article>
      {% endfor %}
    </div>
  </section>

</section>

{% endblock %}